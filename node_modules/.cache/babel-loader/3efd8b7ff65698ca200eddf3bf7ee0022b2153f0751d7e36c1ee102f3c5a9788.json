{"ast":null,"code":"import \"vant/es/image-preview/style\";\nimport _ImagePreview from \"vant/es/image-preview\";\nimport \"vant/es/field/style\";\nimport _Field from \"vant/es/field\";\nimport \"vant/es/uploader/style\";\nimport _Uploader from \"vant/es/uploader\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport \"core-js/modules/es.iterator.reduce.js\";\nimport { _getMsg, _getUnreadMsg, _sendMsg } from \"@/API/im.api\";\nimport { _uploadImage } from \"@/API/fund.api\";\nimport { mapGetters, mapMutations } from \"vuex\";\nimport { uploadimg } from \"@/API/commodity\";\nexport default {\n  name: \"CustomerService\",\n  components: {\n    [_Uploader.name]: _Uploader,\n    [_Field.name]: _Field\n  },\n  data() {\n    return {\n      list: [],\n      value: \"\",\n      lastMsgId: \"\",\n      interval: null,\n      unread: 0,\n      finished: false,\n      // 没有历史消息\n      androidAttrs: null,\n      token_url: \"\",\n      isFirstRequest: true,\n      responserAvatar: '',\n      msgLength: 0,\n      isApp: window.plus ? true : false\n    };\n  },\n  computed: {\n    ...mapGetters({\n      activeLang: \"language\",\n      userInfo: \"userInfo\"\n    })\n  },\n  mounted() {\n    if (['Argos', 'ArgosShop'].includes(process.env.VUE_APP_ITEM_NAME)) {\n      this.responserAvatar = require('@/assets/Argos/avatar.png');\n    } else if (process.env.VUE_APP_ITEM_NAME == 'FamilyShop') {\n      this.responserAvatar = require('@/assets/FamilyShop/avatar.png');\n    } else {\n      this.responserAvatar = require('@/assets/image/service/responser.png');\n    }\n    if (this.$route.query.token) {\n      this.token_url = this.$route.query.token;\n    } else {\n      if (localStorage.getItem(\"token\")) {\n        this.token_url = localStorage.getItem(\"token\");\n      }\n    }\n    if (this.$route.query.lang) {\n      if (this.$route.query.lang == \"cn\") {\n        this.handleSetLang(\"cn\");\n        // {title:'繁体中文',key: 'cn'},\n        // {title: 'English',key: 'en'}\n      } else if (this.$route.query.lang == \"tw\") {\n        this.handleSetLang(\"tw\");\n      } else {\n        this.handleSetLang(\"en\");\n      }\n    }\n    this.fetchList();\n    const model = navigator.userAgent;\n    // 判断是否是安卓手机，是则是true\n    this.androidAttrs = model.indexOf(\"Android\") > -1 || model.indexOf(\"Linux\") > -1;\n  },\n  methods: {\n    ...mapMutations([\"setLanguage\"]),\n    handleSetLang(lang) {\n      // 设置i18n.locale 组件库会按照上面的配置使用对应的文案文件\n      this.$i18n.locale = lang;\n      // 提交mutations\n      this.setLanguage(lang);\n    },\n    onPreview(url) {\n      // 预览\n      _ImagePreview([url]);\n    },\n    showTime(item) {\n      return !!item.createtime;\n      //   // 时间显示\n      //   if (index === 0) {\n      //     return true;\n      //   }\n      //   if (index === this.list.length - 1) {\n      //     return false;\n      //   }\n      //   if (this.list[index].createtime.split(' ')[0] === this.list[index + 1].createtime.split(' ')[1]) {\n      //     return false;\n      //   }\n    },\n    afterRead(file) {\n      // 文件上传\n      this.$toast.loading({\n        duration: 0\n      });\n      this.$toast.loading({\n        duration: 0\n      });\n      var t = this;\n      let formData = new FormData(); //通过formdata上传\n      formData.append('file', file.file);\n      formData.append('moduleName', '123');\n      uploadimg(formData).then(res => {\n        t.$toast.clear();\n        console.log(res);\n        t.send('img', res);\n      }).catch(err => {\n        console.log(err);\n        this.$toast.clear();\n      });\n    },\n    fetchList(message_id = \"\") {\n      // 获取消息列表\n      _getMsg({\n        token: this.token_url,\n        message_id\n      }).then(data => {\n        // this.lastMsgId\n        if (data == null) {\n          data = [];\n        }\n        if (!this.lastMsgId) {\n          this.lastMsgId = data.length && data[data.length - 1][\"id\"];\n        }\n        if (data.length) {\n          if (message_id) {\n            // 加载更多\n            this.lastMsgId = data[data.length - 1][\"id\"];\n            this.list = [...data.reverse(), ...this.list];\n          } else {\n            this.list = [...this.list, ...data.reverse()];\n            let hash = {};\n            this.list = this.list.reduce((preVal, curVal) => {\n              hash[curVal.id] ? \" \" : hash[curVal.id] = true && preVal.push(curVal);\n              return preVal;\n            }, []);\n          }\n          if (data.length < 10) {\n            this.finished = true;\n          }\n          if (this.isFirstRequest) {\n            const _that = this;\n            this.$nextTick(() => {\n              const ele = this.$refs.chatView;\n              if (ele) {\n                ele.scrollTop = ele.scrollHeight;\n                _that.isFirstRequest = false;\n              }\n            });\n          }\n        } else {\n          this.list = [{\n            id: \"1\",\n            send_receive: \"receive\",\n            content: this.$t(\"你好，欢迎来到我们的平台！\"),\n            type: \"text\"\n          }];\n        }\n        // this.list.unshift({\n        //             id: \"1\",\n        //             send_receive: \"receive\",\n        //             content: this.$t(\"你好，欢迎来到我们的平台！\"),\n        //             type: \"text\",\n        //         },)\n        if (!message_id) {\n          this.clearInterval();\n          this.interval = setInterval(() => {\n            this.fetchList();\n          }, 1000);\n        }\n        if (this.msgLength !== this.list.length) {\n          this.scrollToBottom();\n          this.msgLength = this.list.length;\n        }\n        this.list = this.list.map(item => ({\n          ...item,\n          content: item.content.replaceAll('\\n', '<br/>')\n        }));\n        this.list.forEach((item, index) => {\n          data.forEach(item1 => {\n            if (item.id == item1.id && item1.delete_status != item.delete_status) {\n              item.delete_status = item1.delete_status;\n            }\n          });\n        });\n      });\n    },\n    onMore() {\n      // 加载更多\n      this.fetchList(this.lastMsgId);\n    },\n    clearInterval() {\n      if (this.interval) {\n        clearInterval(this.interval);\n        this.interval = null;\n      }\n    },\n    fetchUnread() {\n      // 获取未读\n      _getUnreadMsg().then(data => {\n        this.unread = data;\n        // console.log(data)\n      });\n    },\n    onClickLeft() {\n      // 返回\n      this.$router.go(-1);\n    },\n    send(type = \"text\", content = \"\") {\n      // 发送消息, img 也当消息text\n      if (!content) {\n        this.$notify(this.$t(\"请输入消息内容\"));\n        return;\n      }\n      _sendMsg(type, content, this.token_url).then(data => {\n        this.value = \"\";\n        // document.getElementById('bottom').click()\n        this.isFirstRequest = true;\n        this.fetchList();\n      });\n    },\n    // 滚动条去底部\n    scrollToBottom() {\n      this.$nextTick(() => {\n        try {\n          this.$refs.chatView.scrollTo({\n            top: this.$refs.chatView.scrollHeight,\n            behavior: 'smooth'\n          });\n        } catch (error) {\n          scrollTo(9999999, 9999999);\n        }\n      });\n    }\n  },\n  beforeDestroy() {\n    this.clearInterval();\n    this.fetchList = null;\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}